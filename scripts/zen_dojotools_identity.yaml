alias: Zen DojoTools Identity
description: >
  Zen DojoTools Identity (2.0.0) Authoritative identity manifest for Zen-ID
  aware systems. Scans all person entities or specified list, extracts cabinet
  identity, drawers, ACLs, labels, persona metadata, and ZenAI essence (never
  redacted). Squirrel mode only hides GUID + identity_hash. Used for secure
  routing, auth, and context. Essence Prompt supports prompt loading.
mode: parallel
fields:
  mode:
    name: Mode
    description: Return Type, Summary, Detail, Verbose, oe Essence Prompt - Default Summary
    selector:
      select:
        options:
          - summary
          - detail
          - verbose
          - essence_prompt
    required: true
    default: summary
  person:
    name: Person
    description: Specific person objects to resolve. Leave blank for all.
    selector:
      entity:
        domain: person
        multiple: true
  guids:
    name: GUIDs
    description: >-
      EXPERIMENTAL GUIDs to resolve (comma/space separated). Examples:
      64426e84-95ae-4e04-8e69-08212fcc25ac, 11111111-2222-3333-4444-555555555555
    selector:
      text: {}
  cabinet:
    selector:
      entity:
        multiple: true
        domain: sensor
    description: >-
      Specific cabinets to resolve. Leave blank to pull all households, families
      and persons (including constructs).
  show_people:
    name: Show People
    description: >-
      Include all person entities. Must include at least 1 'show type' People is
      the default option if none selected...
    selector:
      boolean: {}
  show_families:
    name: Show Families
    description: Include all family-type cabinets. Must include at least 1 'show type'
    selector:
      boolean: {}
  show_households:
    name: Show Households
    description: Include all household-type cabinets. Must include at least 1 'show type'
    selector:
      boolean: {}
  include_unregistered:
    name: Include Unregistered
    description: >-
      Include entities without a valid cabinet registration in the manifest.
      When off, only registered (validated) identities are included. Ignored if
      Verbose mode is enabled.
    selector:
      boolean: {}
sequence:
  - variables:
      mode: "{{ mode | default('summary') }}"
      essence_mode: "{{ mode == 'essence_prompt' }}"
      show_people: "{{ show_people | default(false) }}"
      show_families: "{{ show_families | default(false) }}"
      show_households: "{{ show_households | default(false) }}"
      detail_cabinet: |-
        {% if mode == 'detail' or mode == 'verbose' %}
          true
        {% else %}
          {{ detail_cabinet | default(false) }}
        {% endif %}
      detail_relationships: |-
        {% if mode == 'detail' or mode == 'verbose' %}
          true
        {% else %}
          {{ detail_relationships | default(false) }}
        {% endif %}
      detail_essence: |-
        {% if mode == 'detail' or mode == 'verbose' %}
          true
        {% else %}
          {{ detail_essence | default(false) }}
        {% endif %}
      include_unregistered: "{{ include_unregistered | default(false) }}"
      expand_details: |-
        {% if mode == 'detail' or mode == 'verbose' %}
          true
        {% else %}
          {{ expand_details | default(false) }}
        {% endif %}
      verbose: |-
        {% if mode == 'verbose' %}
          true
        {% else %}
          {{ verbose | default(false) }}
        {% endif %}
      expand_all: "{{ verbose or expand_details }}"
      people_list_raw: |-
        {% if person|default([])|length > 0 %}
          {{ person }}
        {% else %}
          {{ states.person | map(attribute='entity_id') | list }}
        {% endif %}
      guids_raw: >-
        {{ (guids|default('')|string).replace(',', ' ').split() if guids is
        defined else [] }}
      squirrel_switch: |-
        {{ expand(label_entities('Zen Squirrel Switch'))
            | selectattr('domain','equalto','input_boolean')
            | map(attribute='entity_id')
            | list
            | first
            | default('input_boolean.friday_secret_squirrel_mode') }}
      squirrel: "{{ is_state(squirrel_switch, 'on') }}"
      cabinet_list: >-
        {% set hh_cab = expand(label_entities('Zen Default Household Cabinet'))
            | selectattr('domain','eq','sensor')
            | map(attribute='entity_id')
            | list | first %}
        {% if not hh_cab %}
          {% set hh_cab = 'sensor.curtis_household_cabinet' %}
        {% endif %} {% set hh_vars = state_attr(hh_cab, 'variables') |
        default({}) %} {% set manifest_drawer =
        hh_vars.get('zen_library_manifest', {}) | default({}) %} {% set
        manifest_value = manifest_drawer.get('value', {}) | default({}) %} {%
        set manifest_ts = manifest_drawer.get('timestamp') | default(None) %}

        {% if manifest_value is string %}
          {% set manifest_data = manifest_value | from_json(default={}) %}
        {% elif manifest_value is mapping %}
          {% set manifest_data = manifest_value %}
        {% else %}
          {% set manifest_data = {} %}
        {% endif %}

        {% if manifest_data is not mapping %}
          {% set manifest_data = {} %}
        {% endif %}

        {% set manifest_fresh = (
            manifest_ts is string and
            (as_timestamp(now()) - as_timestamp(manifest_ts)) < 900
        ) %}

        {% set out = namespace(items=[]) %}

        {% if manifest_data and manifest_fresh %}
          {% for ent, rec in manifest_data.items() if rec is mapping %}
            {# --- Determine cabinet_type from flags on rec or nested VolumeInfo --- #}
            {% set meta = rec.get('metadata', {}) %}
            {% set id = (
              meta.get('id')
              or rec.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('id')
              or rec.get('AI_Cabinet_VolumeInfo', {}).get('id')
            ) %}

            {# Try direct flags on rec, then nested value.flags under either rec or metadata #}
            {% set flags = (
              rec.get('flags')
              or rec.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('flags')
              or meta.get('flags')
              or meta.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('flags')
              or {}
            ) %}
            {% set ctype = (
              'household' if flags.get('household')
              else 'family' if flags.get('family')
              else 'user' if flags.get('user')
              else 'dojo' if flags.get('dojo')
              else 'kata' if flags.get('kata')
              else 'system' if flags.get('system')
              else 'unknown'
            ) %}

            {% if id %}
              {% set entry = {
                'entity_id': ent,
                'guid': id,
                'info': rec,
                'source': ent,
                'cabinet_type': ctype
              } %}
              {% set out.items = out.items + [entry] %}
            {% endif %}

          {% endfor %}
        {% else %}

          {# --- Fallback: cold sensor scan --- #}
          {% set sensors = (
                cabinet
                if cabinet|default([])|length > 0
                else states.sensor | map(attribute='entity_id') | list
             ) %}
          {% for s in sensors %}
            {% set v = state_attr(s,'variables') or {} %}
            {% set volume = v.get('AI_Cabinet_VolumeInfo', {}).get('value', {}) %}
            {% if volume is mapping and volume.get('validation') == 'ALLYOURBASEAREBELONGTOUS' %}
              {% set id = volume.get('id','') %}
              {% set ctype = (
                'household' if volume.get('flags',{}).get('household')
                else 'family'   if volume.get('flags',{}).get('family')
                else 'user'     if volume.get('flags',{}).get('user')
                else 'dojo'     if volume.get('flags',{}).get('dojo')
                else 'kata'     if volume.get('flags',{}).get('kata')
                else 'system'   if volume.get('flags',{}).get('system')
                else 'unknown'
              ) %}
              {% set entry = {
                'entity_id': s,
                'guid': id,
                'info': volume,
                'source': s,
                'cabinet_type': ctype
              } %}
              {% set out.items = out.items + [entry] %}
            {% endif %}
          {% endfor %}
        {% endif %}

        {{ out.items }}
      debug_guid_test: |-
        {% for cab in cabinet_list if cab is mapping %}
          {{ loop.index }}. {{ cab.get('entity_id') }} → guid="{{ cab.get('guid') }}"  id="{{ cab.get('info',{}).get('id') }}"
        {% endfor %}
      reverse_index: >-
        {# Build {"guid_lower": "entity_id"} mapping safely with a namespace
        accumulator #}

        {% set out = namespace(data={}) %}

        {% for cab in cabinet_list if cab is mapping %}
          {% set guid = cab.get('guid') or cab.get('info', {}).get('id') %}
          {% if guid %}
            {% set key = guid|string|lower|trim %}
            {% set eid = cab.get('entity_id','') %}
            {% if key and eid %}
              {% set out.data = out.data | combine({ key: eid }) %}
            {% endif %}
          {% endif %}
        {% endfor %}

        {{ out.data }}
      reverse_person_index: >-
        {# Build {"person.entity_id": "cabinet_entity_id"} by scoring relations
        #}

        {% set out_map = namespace(val={}) %}

        {% set out_scores = namespace(val={}) %}


        {% for c in cabinet_list if c is mapping %}
          {% set info = c.get('info', {}) or {} %}
          {% set eid  = c.get('entity_id','') %}
          {% if not eid %}{% continue %}{% endif %}

          {# --- expanded context discovery --- #}
          {% set ctx = info.get('context', {}) or {} %}
          {% set ctx_val = ctx.get('value', {}) if ctx is mapping else {} %}
          {% set meta_owner = (
              ctx_val.get('owner', {})
              or ctx.get('owner', {})
              or c.get('acls_by_category', {}).get('owner', [{}])[0]
              or {}
          ) %}
          {% set meta_partner = (
              ctx_val.get('partner', {})
              or ctx.get('partner', {})
              or c.get('acls_by_category', {}).get('partner', [{}])[0]
              or {}
          ) %}

          {% set flags = info.get('flags', {}) or {} %}
          {% set is_user = flags.get('user', false) %}
          {% set is_household = flags.get('household', false) %}
          {% set is_family = flags.get('family', false) %}
          {% set is_system = flags.get('system', false) %}
          {% set is_dojo = flags.get('dojo', false) %}

          {# helper to conditionally record best score #}
          {% macro record(k, score) -%}
            {%- set k = k|string -%}
            {%- if k and k != 'None' -%}
              {%- set prev = out_scores.val.get(k) -%}
              {%- if prev is not number or score > prev -%}
                {%- set out_scores.val = out_scores.val | combine({ k: score }) -%}
                {%- set out_map.val    = out_map.val    | combine({ k: eid   }) -%}
              {%- endif -%}
            {%- endif -%}
          {%- endmacro %}

          {# 1) explicit identity mapping, if present #}
          {% set ident = info.get('identity', {}) %}
          {% if ident is mapping and ident.get('entity_id') %}
            {{ record(ident.get('entity_id'), 95) }}
          {% endif %}

          {# 2) resolved owner / partner context (from context or acls_by_category) #}
          {% if meta_owner.get('entity_id') %}
            {{ record(meta_owner.entity_id, 100 if is_user else 70) }}
          {% endif %}
          {% if meta_partner.get('entity_id') %}
            {{ record(meta_partner.entity_id, 60 if is_user else 45) }}
          {% endif %}

          {# 3) ACLs (owner stronger than partner); user cabinets trump others #}
          {% set acls = info.get('acls', {}) or {} %}
          {% for a in (acls.get('owner', []) or []) if a is mapping %}
            {% if a.get('entity_id') %}
              {{ record(a.get('entity_id'), 97 if is_user else 65) }}
            {% endif %}
          {% endfor %}
          {% for a in (acls.get('partner', []) or []) if a is mapping %}
            {% if a.get('entity_id') %}
              {{ record(a.get('entity_id'), 50 if is_user else 45) }}
            {% endif %}
          {% endfor %}

          {# 4) Extremely weak hints (household/family/system) as last resort #}
          {% if is_household and meta_owner.get('entity_id') %}
            {{ record(meta_owner.entity_id, 35) }}
          {% endif %}
          {% if is_family and meta_owner.get('entity_id') %}
            {{ record(meta_owner.entity_id, 30) }}
          {% endif %}
          {% if is_system and meta_owner.get('entity_id') %}
            {{ record(meta_owner.entity_id, 25) }}
          {% endif %}
        {% endfor %}


        {{ out_map.val }}
      people_from_guids: |-
        {% set out = [] %}
        {% for g in guids_raw %}
          {% set key = g|string|lower|trim %}
          {% set p = reverse_index.get(key) %}
          {% if p %}
            {% set out = out + [p] %}
          {% endif %}
        {% endfor %}
        {{ out }}
      guid_warnings: |-
        {% set out = [] %} {% for g in guids_raw %}
          {% if not reverse_index.get(g) %}
            {% set out = out + [ { "type": "unknown_guid", "guid": g } ] %}
          {% endif %}
        {% endfor %} {{ out }}
      manifest_source: "{{ 'drawer' if manifest_fresh else 'rescan' }}"
      manifest_timestamp: "{{ manifest_ts | default('unknown') }}"
      people_list: |-
        {% if essence_mode %}
          {# Essence mode ONLY resolves people explicitly, no toggles #}
          {% if person|default([])|length > 0 %}
            {{ [ person[0] ] }}
          {% else %}
            {{ [ (states.person | map(attribute='entity_id') | list | first ) ] }}
          {% endif %}
        {% else %}
          {# --- normal mode --- #}

          {% set base_people =
              states.person | map(attribute='entity_id') | list
          %}
          {% set base_families =
              cabinet_list
              | selectattr('cabinet_type','equalto','family')
              | map(attribute='entity_id')
              | list
          %}
          {% set base_households =
              cabinet_list
              | selectattr('cabinet_type','equalto','household')
              | map(attribute='entity_id')
              | list
          %}

          {% set any_active = show_people or show_families or show_households %}
          {% if not any_active %}
            {% set show_people = true %}
          {% endif %}

          {% set merged = [] %}

          {% if show_people %}
            {% set merged = merged + base_people %}
          {% endif %}

          {% if show_families %}
            {% set merged = merged + base_families %}
          {% endif %}

          {% if show_households %}
            {% set merged = merged + base_households %}
          {% endif %}

          {% set merged = merged + people_from_guids %}

          {% if person|default([])|length > 0 %}
            {% set merged = person %}
          {% endif %}

          {% if cabinet|default([])|length > 0 %}
            {% set merged = cabinet_list | map(attribute='entity_id') | list %}
          {% endif %}

          {{ merged | unique | list }}
        {% endif %}
      identity_manifest:
        tool: zen_dojotools_identity
        version: 1.9.3
        mode: "{{ 'verbose' if verbose else 'summary' }}"
        resolution:
          status: pending
          warnings: "{{ guid_warnings }}"
          mismatches: []
  - repeat:
      for_each: "{{ people_list }}"
      sequence:
        - variables:
            person_entity: "{{ repeat.item }}"
            guid_val: >-
              {% set pvars = state_attr(person_entity, 'variables') or {} %}

              {% set is_person = person_entity.startswith('person.') %}

              {% set id = '' %}


              {# 1) Preferred: GUID from essence for people #}

              {% if is_person %}
                {% set id = pvars.get('zenai_essence', {}).get('identity', {}).get('guid', '') %}
              {% endif %}


              {# 2) Cabinets/constructs: GUID from VolumeInfo #}

              {% if not id and not is_person %}
                {% set id = pvars.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('id', '') %}
              {% endif %}


              {# 3) Generic fallback: derive GUID by relation to cabinets
              (owner/assistant/ACLs) #}

              {% if not id %}
                {% set found = namespace(guid='') %}
                {% for c in cabinet_list if c is mapping %}
                  {% set info = c.get('info', {}) %}
                  {% set guid = c.get('guid', '') %}

                  {% set own = info.get('owner', {}) or {} %}
                  {% if own.get('entity_id') == person_entity and guid %}
                    {% set found.guid = guid %}
                  {% endif %}

                  {% if not found.guid %}
                    {% set asst = info.get('assistant', {}) or {} %}
                    {% if asst.get('entity_id') == person_entity and guid %}
                      {% set found.guid = guid %}
                    {% endif %}
                  {% endif %}

                  {% if not found.guid %}
                    {% set acls = info.get('acls', {}) or {} %}
                    {% for slot in ['owner','partner'] %}
                      {% set lst = acls.get(slot, []) or [] %}
                      {% for a in lst if a is mapping %}
                        {% if a.get('entity_id') == person_entity and guid %}
                          {% set found.guid = guid %}
                        {% endif %}
                      {% endfor %}
                    {% endfor %}
                  {% endif %}

                  {% if found.guid %}{% break %}{% endif %}
                {% endfor %}
                {% set id = found.guid %}
              {% endif %}

              {{ id }}
            cab: |-
              {% set target = reverse_person_index.get(person_entity) %}
              {% set matched = [] %}

              {% if target %}
                {% set matched = cabinet_list | selectattr('entity_id','equalto',target) | list %}
              {% else %}
                {% set matched = cabinet_list | selectattr('entity_id','equalto',person_entity) | list %}
                {% if matched|length == 0 %}
                  {% for c in cabinet_list if c is mapping %}
                    {% set info = c.get('info', {}) or {} %}
                    {% if info.get('owner', {}).get('entity_id') == person_entity %}
                      {% set matched = [c] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if matched|length == 0 %}
                  {% for c in cabinet_list if c is mapping %}
                    {% set info = c.get('info', {}) or {} %}
                    {% if info.get('assistant', {}).get('entity_id') == person_entity %}
                      {% set matched = [c] %}
                    {% endif %}
                  {% endfor %}
                {% endif %}
                {% if matched|length == 0 and guid_val %}
                  {% set norm_guid = guid_val|string %}
                  {% set matched = cabinet_list | selectattr('guid','equalto',norm_guid) | list %}
                {% endif %}
              {% endif %}

              {% if matched|length > 0 %}
                {% set c = matched[0] %}
                {% if c is mapping %}
                  {% set cid = c.get('entity_id') %}
                  {% set vars = state_attr(cid, 'variables') or {} %}

                  {# --- ESSENCE (prefer entity.variables, then cabinet info) --- #}
                  {% set essence_live = (
                    vars.get('zenai_essence', {}).get('value')
                    or vars.get('zenai_essence', {})
                    or c.get('info', {}).get('zenai_essence', {}).get('value')
                    or c.get('info', {}).get('zenai_essence', {})
                    or c.get('zenai_essence', {}).get('value')
                    or c.get('zenai_essence', {})
                    or {}
                  ) %}
                  
                  {# --- RELATIONSHIPS --- #}
                  {% set rel_live = (
                    vars.get('_zen_relationships', {}).get('value')
                    or vars.get('_zen_relationships', {})
                    or c.get('info', {}).get('_zen_relationships', {}).get('value')
                    or c.get('info', {}).get('_zen_relationships', {})
                    or c.get('_zen_relationships', {}).get('value')
                    or c.get('_zen_relationships', {})
                    or {}
                  ) %}

                  {% set ctx_src = (
                      vars.get('_context', {}).get('value')
                      or vars.get('_context', {})
                      or c.get('_context')
                      or {}
                    ) %}
                  
                  {# normalize context to dict if it came through as list-of-tuples #}
                  {% set ctx_live = (
                      dict(ctx_src)
                      if ctx_src is sequence and ctx_src|length > 0
                      else ctx_src
                    ) %}

                  {% set merged = c
                    | combine(c.get('info', {}))
                    | combine({
                        'cabinet_type': c.get('cabinet_type','unknown'),
                        'entity_id': cid,
                        'source': c.get('source',''),
                        'zenai_essence': essence_live,
                        '_zen_relationships': rel_live,
                        '_context': ctx_live
                      })
                  %}
                  {{ merged }}
                {% else %}
                  {}
                {% endif %}
              {% else %}
                {}
              {% endif %}
            cab_ent: "{{ cab.get('entity_id','') if cab is mapping else '' }}"
            manifest_cabinet_match: >-
              {% set raw = states('sensor.zen_library_manifest') %} {% if raw
              not in ['unknown', None, '', 'unavailable'] %}
                {% set m = raw | from_json %}
                {% if m is mapping %}
                  {% set match = namespace(val={}) %}
                  {% for k, v in m.items() if v is mapping %}
                    {% if v.metadata is mapping
                          and v.metadata.id is defined
                          and (person_entity in v.metadata.id|string
                               or person_entity in k|string) %}
                      {% set match.val = v %}
                    {% endif %}
                  {% endfor %}
                  {{ match.val }}
                {% else %}
                  {}
                {% endif %}
              {% else %}
                {}
              {% endif %}
            manifest_cabinet_found: "{{ manifest_cabinet_match != {} }}"
            labels: |-
              {% if cab is mapping %}
                {{
                  cab.get("labels", [])
                  or cab.get("entity_labels", [])
                  or cab.get("_label_index", [])
                  or []
                }}
              {% else %}
                []
              {% endif %}
            acl: |-
              {% if cab is mapping %}
                {{
                  cab.get("acls", {})
                  or cab.get("acl", {})
                  or cab.get("access", {})
                  or {}
                }}
              {% else %}
                {}
              {% endif %}
            context: |-
              {% if cab is mapping %}
                {{
                  {
                    "friendly_name": cab.get("friendly_name", ""),
                    "description": cab.get("description", ""),
                    "version": cab.get("version", ""),
                    "schema_version": cab.get("schema_version", ""),
                    "flags": cab.get("flags", {}),
                    "source": cab.get("source", ""),
                  }
                }}
              {% else %}
                {}
              {% endif %}
            essence: |-
              {% if cab is mapping %}
                {{
                  cab.get("zenai_essence", {}) 
                  or cab.get("essence", {}) 
                  or {
                    "detail_available": false,
                    "note": "No zenai_essence drawer or embedded essence data found in cabinet."
                  }
                }}
              {% else %}
                {}
              {% endif %}
            relationships: |-
              {% if cab is mapping %}
                {{
                  cab.get("_zen_relationships", {})
                  or cab.get("relationships", {})
                  or {
                    "detail_available": false,
                    "note": "No relationship data found; cabinet may not yet define relationships."
                  }
                }}
              {% else %}
                {}
              {% endif %}
            identity_hash_val: |-
              {% if cab is mapping %}
                {{ cab.get("identity_hash", "") or cab.get("hash", "") or "" }}
              {% else %}
                ""
              {% endif %}
            cabinet_valid: |-
              {{
                cab != {} and
                (
                  cab.get('validation') == 'ALLYOURBASEAREBELONGTOUS'
                  or cab.get('AI_Cabinet_VolumeInfo', {}).get('validation') == 'ALLYOURBASEAREBELONGTOUS'
                  or cab.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('validation') == 'ALLYOURBASEAREBELONGTOUS'
                )
                and (
                  (cab.get('identity', {}).get('entity_id') | string | length > 0)
                  or (cab.get('AI_Cabinet_VolumeInfo', {}).get('value', {}).get('id') | string | length > 0)
                )
              }}
            mismatch_note: |-
              {% set mm = [] %} {% for g in guids_raw %}
                {% set p = reverse_index.get(g) %}
                {% if p and p != person_entity and p in people_list %}
                  {% set _ = mm.append({"person": person_entity, "conflict_with": p, "guid": g}) %}
                {% endif %}
              {% endfor %} {{ mm }}
        - variables:
            result: |-
              {% if essence_mode %}
                {{
                  {
                    "entity_id": person_entity,
                    "ai_user": true,
                    "essence": (
                      essence
                      if not squirrel
                      else { "note": "Essence redacted by Squirrel Mode." }
                    )
                  }
                }}

              {% elif verbose %}
                {{
                  {
                    "entity": {
                      "entity_id": person_entity,
                      "friendly_name": (state_attr(person_entity, "friendly_name") | default(person_entity)),
                      "guid": (guid_val if not squirrel else "[REDACTED]"),
                      "identity_hash": (identity_hash_val if not squirrel else "[REDACTED]"),
                      "essence": (
                        essence if (detail_essence or expand_all)
                        else {
                          "detail_available": (essence|length > 0),
                          "note": (
                            "No zenai_essence drawer found; entity likely not yet registered or missing essence data."
                            if essence|length == 0 else
                            "Essence detail hidden (set detail_essence: true to expand)."
                          )
                        }
                      ),
                      "relationships": (
                        relationships if (detail_relationships or expand_all)
                        else {
                          "detail_available": (relationships|length > 0),
                          "note": (
                            "No relationship data found; check _zen_relationships or family cabinet links."
                            if relationships|length == 0 else
                            "Relationship detail hidden (set detail_relationships: true to expand)."
                          )
                        }
                      )
                    },

                    "cabinet": {
                      "entity_id": cab_ent | default(""),
                      "type": cab.get("cabinet_type", "[unknown]"),
                      "valid": cabinet_valid,
                      "schema": (
                        cab.get("schema")
                        or cab.get("info", {}).get("schema_version")
                        or cab.get("info", {}).get("version")
                        or "[NONE]"
                      ),

                      "context": (
                        (cab.get("info", {}) | tojson | from_json)
                        if (detail_cabinet or expand_all)
                        else {
                          "detail_available": (cab.get("info", {}) | length > 0),
                          "note": (
                            "No cabinet context found – cabinet may be unregistered, malformed, or missing _context drawer."
                            if cab.get("info", {})|length == 0 else
                            "Context detail hidden (set detail_cabinet: true to expand)."
                          )
                        }
                      ),

                      "labels": (
                        cab.get("info", {}).get("entity_labels", [])
                        if (detail_cabinet or expand_all)
                        else {
                          "detail_available": (cab.get("info", {}).get("entity_labels", []) | length > 0),
                          "note": (
                            "No labels present – _label_index missing or empty."
                            if cab.get("info", {}).get("entity_labels", [])|length == 0 else
                            "Label detail hidden (set detail_cabinet: true to expand)."
                          )
                        }
                      ),

                      "acls": (
                        cab.get("info", {}).get("acls", {})
                        if (detail_cabinet or expand_all)
                        else {
                          "detail_available": (cab.get("info", {}).get("acls", {}) | length > 0),
                          "note": (
                            "No ACLs present – missing or malformed VolumeInfo drawer."
                            if cab.get("info", {}).get("acls", {})|length == 0 else
                            "ACL detail hidden (set detail_cabinet: true to expand)."
                          )
                        }
                      ),

                      "note": (
                        "Cabinet validation failed, but manifest lists a matching cabinet for this entity."
                        if not cabinet_valid and manifest_cabinet_found else
                        "Cabinet validation failed – no matching cabinet sensor found for entity."
                        if not cabinet_valid else
                        "Cabinet validated successfully."
                      )
                    },

                    "redacted": squirrel,
                    "manifest_source": manifest_source,
                    "manifest_timestamp": manifest_timestamp,
                    "last_updated": (
                      states[person_entity].last_updated.isoformat()
                      if person_entity in states
                      else "n/a"
                    )
                  }
                }}

              {% else %}
                {{
                  {
                    "entity": {
                      "entity_id": person_entity,
                      "friendly_name": (state_attr(person_entity, "friendly_name") | default(person_entity)),
                      "guid": (guid_val if not squirrel else "[REDACTED]")
                    },
                    "cabinet": {
                      "entity_id": cab_ent | default(""),
                      "type": cab.get("cabinet_type", "unknown"),
                      "labels": {
                        "detail_available": (labels | length > 0)
                      }
                    },
                    "last_updated": (
                      states[person_entity].last_updated.isoformat()
                      if person_entity in states
                      else "n/a"
                    )
                  }
                }}
              {% endif %}
        - variables:
            include_entity: |-
              {{
                verbose or
                (include_unregistered or (cabinet_valid | default(false)))
              }}
        - choose:
            - conditions:
                - condition: template
                  value_template: "{{ include_entity }}"
              sequence:
                - variables:
                    identity_manifest: |-
                      {{
                        identity_manifest
                        | combine({ person_entity: result }, recursive=True)
                        | combine({
                            "resolution": {
                              "status": "success",
                              "warnings": identity_manifest.resolution.warnings,
                              "mismatches": (identity_manifest.resolution.mismatches + mismatch_note)
                            }
                          }, recursive=True)
                      }}
          default:
            - variables:
                identity_manifest: |-
                  {{
                    identity_manifest
                    | combine({
                        "resolution": {
                          "status": "success",
                          "warnings": identity_manifest.resolution.warnings,
                          "mismatches": identity_manifest.resolution.mismatches
                        }
                      }, recursive=True)
                  }}
  - variables:
      group_summary: |-
        {{
          {
            "people": (
              states.person | map(attribute='entity_id') | list
              if show_people else []
            ),
            "families": (
              cabinet_list
              | selectattr('cabinet_type','equalto','family')
              | map(attribute='entity_id')
              | list
              if show_families else []
            ),
            "households": (
              cabinet_list
              | selectattr('cabinet_type','equalto','household')
              | map(attribute='entity_id')
              | list
              if show_households else []
            )
          }
        }}
      identity_manifest: |-
        {% if essence_mode %}
          {{ identity_manifest }}   {# do NOT add group summary #}
        {% else %}
          {{
            identity_manifest
            | combine({ "group_summary": group_summary }, recursive=True)
          }}
        {% endif %}
  - stop: Done.
    response_variable: identity_manifest
  - set_conversation_response: "{{ identity_manifest }}"
icon: mdi:id-card
