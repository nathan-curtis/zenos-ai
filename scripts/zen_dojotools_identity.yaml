alias: Zen DojoTools Identity
mode: parallel
max: 10
description: >
  Zen DojoTools Identity 3.8.2 RC1 — This tool resolves identities within the
  ZenOS-AI household. When called with no target, it must invoke
  zen_cabinets(None) and return the full, redacted roster of all registered
  users, AI constructs, and cabinets. When a target is provided—such as a
  person entity_id, cabinet entity_id, label, or UUID—the tool must normalize
  the input, preserve full person.* values, and pass the normalized target to
  zen_cabinets(target) to retrieve the corresponding identity record.

  This tool is used to identify interacting users or constructs, verify
  cabinet ownership, map GUIDs, resolve labels, validate identity before acting,
  and load metadata associated with a specific identity. Results must always be
  returned as valid JSON structures for downstream reasoning.

  Under Construction: cabinet-based and person-based direct selectors are being
  expanded for future releases. Requires zen_os_1rc.jinja 3.5.2 or newer.
fields:
  user_label:
    selector:
      text: null
    name: User Label
    description: >-
      Optional, the Index label referring to a valid ZenOS-AI user.
  user_cabinet:
    name: User Cabinet
    description: >-
      Under Construction - not functional yet.
      Optional, the entity_id of a valid user cabinet sensor.
    selector:
      entity:
        domain: sensor
        multiple: false
  user_entity_id:
    name: Person
    description: >-
      Under Construction - not functional yet.
      Optional, the entity_id of a valid user person entity.
    required: false
    selector:
      entity:
        domain: person
        multiple: false
  user_guid:
    name: User GUID
    description: >-
      Under Construction - not functional yet.
      Optional, the Zen AI OS User GUID of a valid user.
    required: false
    selector:
      text:
        multiline: false
sequence:
  - variables:
      user_label: "{{ user_label | default('') }}"
      user_cabinet: "{{ user_cabinet | default('') }}"
      user_entity_id: "{{ user_entity_id | default('') }}"
      user_guid: >-
        {%- set ug = user_guid | default('') | trim -%} {%- set pattern =
        "(?i)^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$"
        -%} {{ ug if ug is match(pattern) else '' }}
      target: |-
        {%- if user_label | default('') | trim != '' -%}
          {{ user_label | trim }}
        {%- elif user_cabinet | default('') | trim != '' -%}
          {{ user_cabinet | trim }}
        {%- elif user_entity_id | default('') | trim != '' -%}
          {{ user_entity_id | trim }}
        {%- elif user_guid | default('') | trim != '' -%}
          {{ user_guid | trim }}
        {%- else -%}
          ''
        {%- endif -%}
      raw_target: "{{ target | default('') | trim }}"
      normalized: |-
        {%- set rt = raw_target | string | trim -%}
      
        {# --- 0. Canonical empty/null detection (kills '', "", ' ', etc.) --- #}
        {%- if rt in ['', "''", '""', "' '", '" "', None] -%}
          {{ None }}
      
        {# --- 1. Preserve full person entities verbatim --- #}
        {%- elif rt.startswith('person.') -%}
          {{ rt }}
      
        {# --- 2. Preserve full cabinet sensors verbatim --- #}
        {%- elif rt.startswith('sensor.') -%}
          {{ rt }}
      
        {# --- 3. Accept UUID formats (with/without hyphens, case-insensitive) --- #}
        {%- elif rt is match("(?i)^[0-9a-f]{8}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{4}-?[0-9a-f]{12}$") -%}
          {{ rt }}
      
        {# --- 4. Reject ANYTHING containing a dot that isn’t person/sensor --- #}
        {%- elif '.' in rt -%}
          {{ None }}
      
        {# --- 5. Otherwise treat as a plain label --- #}
        {%- else -%}
          {{ rt }}
        {%- endif -%}

  - variables:
      cab_json: |
        {% import 'zen_os_1rc.jinja' as zen %}
        {{ zen.zen_cabinets(normalized) }}
  
      # Safety wrapper: ensure cab_json is valid JSON
      cab: |-
        {%- set raw = cab_json | trim -%}
  
        {# 0. Empty/None → valid empty result #}
        {%- if raw in ['', None] -%}
          {{ {"result": [], "error": "empty_input"} | tojson }}
  
        {# 1. Detect "not_found" blocks BEFORE from_json #}
        {%- elif '"error"' in raw and '"not_found"' in raw -%}
          {{ {"result": [], "error": "not_found"} | tojson }}
  
        {# 2. Attempt normal JSON load #}
        {%- else -%}
          {{ raw | from_json | tojson }}
        {%- endif %}
  - variables:
      response: |
        {{
          {
            "result": cab,
            "target_normalized": normalized,
            "timestamp": now().isoformat()
          }
        }}
  - stop: Return Variables
    response_variable: response
