alias: Zen DojoTools Volume Redirector RC1
description: >
  DojoTools Volume Redirector (v3.9.2 RC1) — Now with 100% more return data.
  Hardened redirector for legacy global-variable events. Translates
  *_legacy events into Dojo-compatible cabinet handlers. Validates cabinet
  membership using a manifest cabinet and emits structured telemetry for
  success and failure cases.
triggers:
  - trigger: event
    event_type: set_variable_legacy
    id: set
  - trigger: event
    event_type: remove_variable_legacy
    id: remove
  - trigger: event
    event_type: clear_variable_legacy
    id: clear
  - trigger: event
    event_type: dojo_volume_redirector_probe
    id: probe
conditions: []
actions:
  - variables:
      # Core cabinet volume entities (SANITIZED / TEMPLATE-FRIENDLY)
      vol_system: sensor.zen_system_cabinet
      vol_household: sensor.zen_default_household_cabinet
      vol_family: sensor.zen_default_family_cabinet
      vol_kata: sensor.zen_default_kata_cabinet
      vol_history: sensor.zen_default_history_cabinet
      vol_ai_history: sensor.zen_default_ai_history_cabinet
      vol_dojo: sensor.zen_default_dojo_cabinet
      vol_summary: sensor.zen_default_summary_cabinet
      vol_scratch: ""
      vol_aiuser: sensor.zen_default_aiuser_cabinet
      vol_user_primary: sensor.zen_default_user_primary_cabinet
      vol_user_secondary: sensor.zen_default_user_secondary_cabinet
      vol_charming: ""

      recognized_volumes: |
        {{
          [
            vol_system,
            vol_summary,
            vol_household,
            vol_family,
            vol_aiuser,
            vol_user_primary,
            vol_user_secondary,
            vol_kata,
            vol_history,
            vol_ai_history,
            vol_dojo
          ]
        }}

      # Manifest / metadata
      manifest_key: zen_library_manifest
      zen_default_fam_cab: "{{ vol_household }}"
      manifest_entity: "{{ zen_default_fam_cab }}"
      manifest_data: |-
        {{
          (
            state_attr(manifest_entity, 'variables')
            | default({})
          ).get(manifest_key, {})
          .get('value', {})
        }}

      # Incoming event payload
      event_type: "{{ trigger.event.event_type }}"
      key: "{{ trigger.event.data.key | default('') }}"
      value: "{{ trigger.event.data.value | default('') }}"
      set_timestamp: "{{ trigger.event.data.set_timestamp | default(false) }}"
      volume_entity: "{{ trigger.event.data.volume_entity | default('') }}"
      log_events: "{{ trigger.event.data.log_events | default(false) }}"

      # Manifest → volume entry, flags, GUIDs
      manifest_volume_entry: >-
        {% set md = manifest_data if manifest_data is mapping else {} %}
        {% set vol_key = volume_entity | string %}
        {{ md.get(vol_key, {}) }}
      manifest_metadata: "{{ manifest_volume_entry.get('metadata', {}) }}"
      manifest_flags: "{{ manifest_metadata.get('flags', {}) }}"
      manifest_guid: >-
        {%- if manifest_metadata is mapping and manifest_metadata.get('id') -%}
          {{ manifest_metadata.get('id') }}
        {%- elif manifest_volume_entry is mapping and manifest_volume_entry.get('id') -%}
          {{ manifest_volume_entry.get('id') }}
        {%- else -%}
          {{ '' }}
        {%- endif -%}

      # Cabinet-side info + GUID
      cabinet_info: >
        {% set vars = state_attr(volume_entity, 'variables') | default({}, true) %}
        {% set entry = vars.get('AI_Cabinet_VolumeInfo', {}) %}
        {{ entry if entry is mapping else {} }}
      cabinet_info_value: |
        {{ cabinet_info.get('value', {}) if cabinet_info is mapping else {} }}
      cabinet_guid: >
        {% set v = cabinet_info_value if cabinet_info_value is mapping else {} %}
        {% if v.get('id') %}
          {{ v.get('id') }}
        {% else %}
          ''
        {% endif %}
      guid_mismatch: "{{ manifest_guid and cabinet_guid and (manifest_guid != cabinet_guid) }}"

      # Canonical, sanitized volume name
      canonical_volume_name: >-
        {# 1. Prefer HA friendly_name if present #}
        {% set fn = (state_attr(volume_entity, 'friendly_name') | default('', true)) | string | trim %}
        {% if fn | lower not in ['unknown', 'unavailable', 'none', 'null', ''] %}
          {{ fn }}
        {% else %}
          {# 2. Fallback to curated, sanitized map #}
          {% if volume_entity == vol_summary %}summary_default
          {% elif volume_entity == vol_household %}household_default
          {% elif volume_entity == vol_family %}family_default
          {% elif volume_entity == vol_aiuser %}aiuser_default
          {% elif volume_entity == vol_user_primary %}user_primary
          {% elif volume_entity == vol_user_secondary %}user_secondary
          {% elif volume_entity == vol_kata %}kata_storage
          {% elif volume_entity == vol_history %}history_storage
          {% elif volume_entity == vol_ai_history %}ai_history
          {% elif volume_entity == vol_dojo %}dojo_storage
          {% else %}unknown{% endif %}
        {% endif %}

      routing_status: pending
      routing_action: none
      routed_volume: "{{ volume_entity }}"

  - alias: Log the transaction?
    if:
      - alias: Log?
        condition: template
        value_template: "{{ log_events }}"
    then:
      - action: logbook.log
        data:
          name: "{{ event_type }}:"
          message: >-
            {{ key | default('-') }}
            {%- if event_type == 'set_variable_legacy' -%}
              : {{ value | default('not defined!') }}.
            {%- endif -%}

  - alias: Handle redirector probe events
    choose:
      - conditions:
          - condition: trigger
            id:
              - probe
        sequence:
          - event: dojo_volume_redirector_probe_result
            event_data:
              status: |-
                {% if volume_entity
                 and volume_entity in recognized_volumes
                 and manifest_volume_entry is mapping
                 and manifest_volume_entry != {}
                %}
                  {% if guid_mismatch %}
                    warning
                  {% else %}
                    ready
                  {% endif %}
                {% else %}
                  error
                {% endif %}
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              key: "{{ key }}"
              requested_action: "{{ trigger.event.data.requested_action | default('probe') }}"
              manifest_entry_found: >-
                {{ manifest_volume_entry is mapping and manifest_volume_entry != {} }}
              recognized_volume: "{{ volume_entity in recognized_volumes }}"
              manifest_guid: "{{ manifest_guid }}"
              cabinet_guid: "{{ cabinet_guid }}"
              guid_mismatch: "{{ guid_mismatch }}"
              failure_reason: >-
                {% if not volume_entity %}
                  missing_volume_entity
                {% elif volume_entity not in recognized_volumes %}
                  volume_not_recognized
                {% elif manifest_volume_entry is not mapping or manifest_volume_entry == {} %}
                  volume_missing_from_manifest
                {% elif guid_mismatch %}
                  guid_mismatch
                {% else %}
                  ok
                {% endif %}
          - stop: Redirector Probe Complete

  - alias: Validate redirect request
    choose:
      - conditions:
          - condition: template
            value_template: "{{ (volume_entity | default('')) | trim == '' }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: missing_volume_entity
              event_type: "{{ event_type }}"
              key: "{{ key }}"
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              set_timestamp: "{{ set_timestamp }}"
          - stop: Redirect Validation Failed

      - conditions:
          - condition: template
            value_template: "{{ volume_entity not in recognized_volumes }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: volume_not_recognized
              event_type: "{{ event_type }}"
              key: "{{ key }}"
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              set_timestamp: "{{ set_timestamp }}"
          - stop: Redirect Validation Failed

      - conditions:
          - condition: template
            value_template: >-
              {{ manifest_volume_entry is not mapping or manifest_volume_entry == {} }}
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: volume_missing_from_manifest
              event_type: "{{ event_type }}"
              key: "{{ key }}"
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              set_timestamp: "{{ set_timestamp }}"
              manifest_guid: "{{ manifest_guid }}"
          - stop: Redirect Validation Failed

      - conditions:
          - condition: template
            value_template: >-
              {{ event_type in ['set_variable_legacy', 'remove_variable_legacy'] }}
          - condition: template
            value_template: "{{ (key | default('')) | trim == '' }}"
        sequence:
          - event: dojo_volume_redirector_result
            event_data:
              status: error
              failure: missing_key
              event_type: "{{ event_type }}"
              volume_entity: "{{ volume_entity }}"
              volume_name: "{{ canonical_volume_name }}"
              set_timestamp: "{{ set_timestamp }}"
          - stop: Redirect Validation Failed

  - choose:
      # =====================================================
      # AI Summary Cabinet
      # =====================================================
      - conditions:
          - alias: AI Summary Cabinet
            condition: template
            value_template: "{{ volume_entity == vol_summary }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - Summary
                    event: set_variable_summary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - Summary
                    event: remove_variable_summary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - Summary
                    event: clear_variable_summary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # Household Cabinet
      # =====================================================
      - conditions:
          - alias: Household Storage
            condition: template
            value_template: "{{ volume_entity == vol_household }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - Household
                    event: set_variable_household_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - Household
                    event: remove_variable_household_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - Household
                    event: clear_variable_household_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # Family Cabinet
      # =====================================================
      - conditions:
          - alias: Family Storage
            condition: template
            value_template: "{{ volume_entity == vol_family }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - Family
                    event: set_variable_family_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - Family
                    event: remove_variable_family_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - Family
                    event: clear_variable_family_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # AI User Cabinet (Primary AI persona)
      # =====================================================
      - conditions:
          - alias: AI User Volume
            condition: template
            value_template: "{{ volume_entity == vol_aiuser }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - AI User
                    event: set_variable_aiuser_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - AI User
                    event: remove_variable_aiuser_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - AI User
                    event: clear_variable_aiuser_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # User Primary Cabinet
      # =====================================================
      - conditions:
          - alias: User Primary Volume
            condition: template
            value_template: "{{ volume_entity == vol_user_primary }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - User Primary
                    event: set_variable_user_primary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - User Primary
                    event: remove_variable_user_primary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - User Primary
                    event: clear_variable_user_primary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # User Secondary Cabinet
      # =====================================================
      - conditions:
          - alias: User Secondary Volume
            condition: template
            value_template: "{{ volume_entity == vol_user_secondary }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - User Secondary
                    event: set_variable_user_secondary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - User Secondary
                    event: remove_variable_user_secondary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - User Secondary
                    event: clear_variable_user_secondary_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # Kata Storage Cabinet
      # =====================================================
      - conditions:
          - alias: Zen Kata Storage
            condition: template
            value_template: "{{ volume_entity == vol_kata }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - Katas
                    event: set_variable_kata_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - Katas
                    event: remove_variable_kata_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - Katas
                    event: clear_variable_kata_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # Dojo Storage Cabinet
      # =====================================================
      - conditions:
          - alias: Zen Dojo Storage
            condition: template
            value_template: "{{ volume_entity == vol_dojo }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - Dojo
                    event: set_variable_dojo_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - Dojo
                    event: remove_variable_dojo_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - Dojo
                    event: clear_variable_dojo_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # History Cabinet
      # =====================================================
      - conditions:
          - alias: Zen History Cabinet
            condition: template
            value_template: "{{ volume_entity == vol_history }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - History
                    event: set_variable_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - History
                    event: remove_variable_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - History
                    event: clear_variable_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"

      # =====================================================
      # AI History Cabinet
      # =====================================================
      - conditions:
          - alias: Zen AI History Cabinet
            condition: template
            value_template: "{{ volume_entity == vol_ai_history }}"
        sequence:
          - choose:
              - conditions:
                  - condition: trigger
                    id:
                      - set
                sequence:
                  - alias: Set - AI History
                    event: set_variable_ai_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                      value: "{{ value | default('') }}"
                      set_timestamp: "{{ set_timestamp | default(false) }}"
                      log_events: "{{ log_events }}"
                  - variables:
                      routing_status: success
                      routing_action: set
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - remove
                sequence:
                  - alias: Remove - AI History
                    event: remove_variable_ai_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: remove
                      routed_volume: "{{ volume_entity }}"

              - conditions:
                  - condition: trigger
                    id:
                      - clear
                sequence:
                  - alias: Clear - AI History
                    event: clear_variable_ai_history_cabinet
                    event_data:
                      key: "{{ key | default('') }}"
                  - variables:
                      routing_status: success
                      routing_action: clear
                      routed_volume: "{{ volume_entity }}"
    default:
      - event: dojo_volume_redirector_result
        event_data:
          status: error
          failure: unmatched_volume_route
          event_type: "{{ event_type }}"
          volume_entity: "{{ volume_entity }}"
          volume_name: "{{ canonical_volume_name }}"
          key: "{{ key }}"
          set_timestamp: "{{ set_timestamp }}"
      - variables:
          routing_status: error
          routing_action: none
          final_response:
            status: error
            message: |
              Target volume {{ volume_entity | default('unknown') }} not found.
      - stop: Target Volume Not Found
        response_variable: final_response

  - alias: Emit success telemetry
    if:
      - condition: template
        value_template: "{{ routing_status == 'success' }}"
    then:
      - event: dojo_volume_redirector_result
        event_data:
          status: success
          action: "{{ routing_action }}"
          event_type: "{{ event_type }}"
          volume_entity: "{{ routed_volume }}"
          volume_name: "{{ canonical_volume_name }}"
          key: "{{ key }}"
          value_length: "{{ value | string | length }}"
          set_timestamp: "{{ set_timestamp }}"
          manifest_guid: "{{ manifest_guid }}"
          cabinet_guid: "{{ cabinet_guid }}"
          guid_mismatch: "{{ guid_mismatch }}"
          manifest_flags: "{{ manifest_flags }}"
          manifest_entry_found: >-
            {{ manifest_volume_entry is mapping and manifest_volume_entry != {} }}
      - variables:
          final_response: |-
            {{
              {
                "status": "success",
                "action": routing_action,
                "event_type": event_type,
                "volume_entity": routed_volume,
                "volume_name": canonical_volume_name,
                "key": key,
                "value_length": (value | string | length),
                "set_timestamp": set_timestamp,
                "manifest_guid": manifest_guid,
                "cabinet_guid": cabinet_guid,
                "guid_mismatch": guid_mismatch,
                "manifest_flags": manifest_flags,
                "manifest_entry_found": (
                  manifest_volume_entry is mapping
                  and manifest_volume_entry != {}
                )
              } | tojson
            }}
      - stop: Redirect Complete
        response_variable: final_response

mode: parallel
max: 10
