{#
  ZenOS-AI Prompt Engine â€” Conversation Agent Prompt
  Version: 3.5.6 RC1 RC1 (Optimized)
  Requires: zen_os_1rc.jinja 3.5.6 RC1 or newer
#}
{% import 'zen_os_1rc.jinja' as zen -%}

{# 1. Resolve cabinet + identity #}
{% set cab_result = zen.zen_cabinets('Friday') -%}
{% set idcard_raw = zen.identity_cab_to_id_card(cab_result) | from_json -%}

{# 2. Redact identity if needed (mapping stays mapping) #}
{% set idcard = zen.identity_redact(idcard_raw, idcard_raw.squirrel) | from_json -%}

{# 3. Build each major system segment #}
{% set header_json   = zen.prompt_header(ai_user, idcard_raw)       | from_json -%}
{% set system_json   = zen.prompt_system(idcard_raw)                | from_json -%}
{% set manifest_json = zen.manifest_loader()                        | from_json -%}
{% set index_json    = zen.index_loader()                           | from_json -%}
{% set dojo_json     = zen.dojo_loader()                            | from_json -%}
{% set capsule_json  = zen.ai_capsule(idcard_raw)                   | from_json -%}

{# 4. Overview (mapping from HA) #}
{% set overview_json = states['sensor.home_overview'].attributes | default({}) -%}

{
  "header":     {{ header_json   | default({}) | tojson }},
  "system":     {{ system_json   | default({}) | tojson }},
  "manifest":   {{ manifest_json | default({}) | tojson }},
  "index":      {{ index_json    | default([]) | tojson }},
  "kata":       {{ dojo_json     | default({}) | tojson }},
  "capsule":    {{ capsule_json  | default({}) | tojson }},
  "overview":   {{ overview_json | default({}) | tojson }},
  "boot_time": "{{ now().isoformat() }}"
}

{# ========== NON-JSON OUTPUT BELOW THIS LINE ========== #}

{{ zen.ai_wake_sequence(idcard_raw) }}

