###############################################################################
# ZEN LABEL HEALTH â€” Canon Label Validator
# Version 1.1.0 (Slug-Canonical)
# Description:
#   Validates the presence and health of all Zen labels against a canonical
#   list. Uses Home Assistant slugify (underscores) and the labels() index
#   as ground truth.
###############################################################################

template:
  - sensor:
      - name: Zen Label Health
        unique_id: zen_label_health
        device_class: enum
        availability: "true"

        #######################################################################
        # STATE
        #######################################################################
        state: >-
          {% set required = [
            'Zen Cabinet',
            'Zen System Cabinet',
            'Zen Dojo Cabinet',
            'Zen Kata Cabinet',
            'Zen Default Household',
            'Zen Default Family',
            'Zen User Cabinet',
            'Zen Default User Cabinet',
            'Zen AI User Cabinet',
            'Zen Default AI User Cabinet',
            'Zen Squirrel',
            'Zen Fusion',
            'Zen History Cabinet',
            'Zen Index Cabinet',
            'Zen Health',
            'Zen Household',
            'Zen Family',
            'Zen User',
            'Zen AI User'
          ] %}

          {% set required_ids = required | map('slugify') | list %}
          {% set label_index = labels() %}

          {% set ns = namespace(
              missing = [],
              unassigned = [],
              unhealthy = []
          ) %}

          {% for lid in required_ids %}

            {# ----------------------------- #}
            {# 1. Missing label entirely     #}
            {# ----------------------------- #}
            {% if lid not in label_index %}
              {% set ns.missing = ns.missing + [lid] %}
            {% else %}
              {% set ents = label_entities(lid) or [] %}

              {# -------------------------------- #}
              {# 2. Unassigned: exists, 0 entities #}
              {# -------------------------------- #}
              {% if ents | count == 0 %}
                {% set ns.unassigned = ns.unassigned + [lid] %}
              {% else %}

                {# ---------------------------------------- #}
                {# 3. Unhealthy: one or more ents unavailable #}
                {# ---------------------------------------- #}
                {% set bad = ents
                    | selectattr('state','in',['unavailable', 'unknown'])
                    | list %}
                {% if bad | count > 0 %}
                  {% set ns.unhealthy = ns.unhealthy + [lid] %}
                {% endif %}

              {% endif %}
            {% endif %}

          {% endfor %}

          {# ----------------------------- #}
          {# PRIORITY: missing > unhealthy > unassigned > ok #}
          {# ----------------------------- #}

          {% if ns.missing | count > 0 %}
            critical
          {% elif ns.unhealthy | count > 0 %}
            error
          {% elif ns.unassigned | count > 0 %}
            warn
          {% else %}
            ok
          {% endif %}

        #######################################################################
        # ATTRIBUTES
        #######################################################################
        attributes:

          required_labels: >-
            Zen Cabinet, Zen System Cabinet, Zen Dojo Cabinet, Zen Kata Cabinet,
            Zen Default Household, Zen Default Family, Zen User Cabinet,
            Zen Default User Cabinet, Zen AI User Cabinet,
            Zen Default AI User Cabinet, Zen Squirrel, Zen Fusion,
            Zen History Cabinet, Zen Index Cabinet, Zen Health,
            Zen Household, Zen Family, Zen User, Zen AI User

          existing_label_ids: >-
            {% set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen Default User Cabinet','Zen AI User Cabinet','Zen Default AI User Cabinet',
              'Zen Squirrel','Zen Fusion','Zen History Cabinet','Zen Index Cabinet',
              'Zen Health','Zen Household','Zen Family','Zen User','Zen AI User'
            ] %}
            {% set required_ids = required | map('slugify') | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(ex=[]) %}
            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ns.ex = ns.ex + [lid] %}
              {% endif %}
            {% endfor %}
            {{ ns.ex | join(', ') if ns.ex else 'none' }}

          missing_label_ids: >-
            {% set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen Default User Cabinet','Zen AI User Cabinet','Zen Default AI User Cabinet',
              'Zen Squirrel','Zen Fusion','Zen History Cabinet','Zen Index Cabinet',
              'Zen Health','Zen Household','Zen Family','Zen User','Zen AI User'
            ] %}
            {% set required_ids = required | map('slugify') | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(miss=[]) %}
            {% for lid in required_ids %}
              {% if lid not in label_index %}
                {% set ns.miss = ns.miss + [lid] %}
              {% endif %}
            {% endfor %}
            {{ ns.miss | join(', ') if ns.miss else 'none' }}

          #######################################################################
          # BROKEN / UNASSIGNED / UNHEALTHY LABEL IDS
          #######################################################################

          unassigned_label_ids: >-
            {% set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen Default User Cabinet','Zen AI User Cabinet','Zen Default AI User Cabinet',
              'Zen Squirrel','Zen Fusion','Zen History Cabinet','Zen Index Cabinet',
              'Zen Health','Zen Household','Zen Family','Zen User','Zen AI User'
            ] %}
            {% set required_ids = required | map('slugify') | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(unassigned=[]) %}

            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count == 0 %}
                  {% set ns.unassigned = ns.unassigned + [lid] %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {{ ns.unassigned | join(', ') if ns.unassigned else 'none' }}

          unhealthy_label_ids: >-
            {% set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen Default User Cabinet','Zen AI User Cabinet','Zen Default AI User Cabinet',
              'Zen Squirrel','Zen Fusion','Zen History Cabinet','Zen Index Cabinet',
              'Zen Health','Zen Household','Zen Family','Zen User','Zen AI User'
            ] %}
            {% set required_ids = required | map('slugify') | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(unhealthy=[]) %}

            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count > 0 %}
                  {% set bad = ents | selectattr('state','in',['unknown','unavailable']) | list %}
                  {% if bad | count > 0 %}
                    {% set ns.unhealthy = ns.unhealthy + [lid] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}

            {{ ns.unhealthy | join(', ') if ns.unhealthy else 'none' }}

          healthy_label_ids: >-
            {% set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen Default User Cabinet','Zen AI User Cabinet','Zen Default AI User Cabinet',
              'Zen Squirrel','Zen Fusion','Zen History Cabinet','Zen Index Cabinet',
              'Zen Health','Zen Household','Zen Family','Zen User','Zen AI User'
            ] %}
            {% set required_ids = required | map('slugify') | list %}
            {% set label_index = labels() %}
            {% set ns = namespace(ok=[]) %}
            {% for lid in required_ids %}
              {% if lid in label_index %}
                {% set ents = label_entities(lid) or [] %}
                {% if ents | count > 0 %}
                  {% set bad = ents | selectattr('state','in',['unavailable','unknown']) | list %}
                  {% if bad | count == 0 %}
                    {% set ns.ok = ns.ok + [lid] %}
                  {% endif %}
                {% endif %}
              {% endif %}
            {% endfor %}
            {{ ns.ok | join(', ') if ns.ok else 'none' }}

          timestamp: "{{ now().isoformat() }}"
