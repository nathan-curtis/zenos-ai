###############################################################################
# ZEN LABEL HEALTH — Canon Label Validator
# Version 1.0.0
# release date: 2024-06-10
# zenos_ai version: 1.0.0 (RC1)
# Description:
#   This sensor checks for the presence and health of essential Zen labels 
# State: ok | warning | error | critical
# Attributes:
#   required_labels
#   existing_labels
#   missing_labels
#   broken_labels
#   healthy_labels
#   timestamp
###############################################################################

template:
  - sensor:
      - name: Zen Label Health
        unique_id: zen_label_health
        device_class: enum

        # ---------------------------------------------------------
        # AVAILABILITY = always on (labels always resolvable)
        # ---------------------------------------------------------
        availability: "true"

        # ---------------------------------------------------------
        # SENSOR STATE
        # ---------------------------------------------------------
        state: >-
          {% set required = [
            'Zen Cabinet',
            'Zen System Cabinet',
            'Zen Dojo Cabinet',
            'Zen Kata Cabinet',
            'Zen Default Household',
            'Zen Default Family',
            'Zen User Cabinet',
            'Zen AI User Cabinet',
            'Zen Squirrel',
            'Zen Fusion',
            'Zen History Cabinet'
          ] %}

          {% set missing = [] %}
          {% set unhealthy = [] %}

          {% for label in required %}
            {% set ents = label_entities(label) | default([], true) %}
            {% if ents | count == 0 %}
              {% set _ = missing.append(label) %}
            {% else %}
              {# Any entity that is unavailable/unknown = label unhealthy #}
              {% set bad = ents
                   | selectattr('state','in',['unavailable','unknown'])
                   | list %}
              {% if bad | count > 0 %}
                {% set _ = unhealthy.append(label) %}
              {% endif %}
            {% endif %}
          {% endfor %}

          {% if missing | count > 0 %}
            critical
          {% elif unhealthy | count > 0 %}
            error
          {% else %}
            ok
          {% endif %}

        # ---------------------------------------------------------
        # ATTRIBUTES — must recompute everything cleanly
        # ---------------------------------------------------------
        attributes:

          required_labels: >-
            Zen Cabinet, Zen System Cabinet, Zen Dojo Cabinet, Zen Kata Cabinet,
            Zen Default Household, Zen Default Family, Zen User Cabinet,
            Zen AI User Cabinet, Zen Squirrel, Zen Fusion, Zen History Cabinet

          existing_labels: >-
            {%- set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen AI User Cabinet','Zen Squirrel','Zen Fusion','Zen History Cabinet'
            ] -%}

            {%- set ns = namespace(existing=[]) -%}

            {%- for label in required -%}
              {%- set ents = (label_entities(label) or []) | list -%}
              {%- if ents | count > 0 -%}
                {%- set ns.existing = ns.existing + [label] -%}
              {%- endif -%}
            {%- endfor -%}

            {{ ns.existing | join(', ') if ns.existing else 'none' }}

          missing_labels: >-
            {%- set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen AI User Cabinet','Zen Squirrel','Zen Fusion','Zen History Cabinet'
            ] -%}

            {%- set ns = namespace(missing=[]) -%}

            {%- for label in required -%}
              {%- set ents = (label_entities(label) or []) | list -%}
              {%- if ents | count == 0 -%}
                {%- set ns.missing = ns.missing + [label] -%}
              {%- endif -%}
            {%- endfor -%}

            {{ ns.missing | join(', ') if ns.missing else 'none' }}

          broken_labels: >-
            {%- set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen AI User Cabinet','Zen Squirrel','Zen Fusion','Zen History Cabinet'
            ] -%}

            {%- set ns = namespace(broken=[]) -%}

            {%- for label in required -%}
              {%- set ents = (label_entities(label) or []) | list -%}
              {%- if ents | count > 0 -%}
                {%- set bad = ents | selectattr('state','in',['unavailable','unknown']) | list -%}
                {%- if bad | count > 0 -%}
                  {%- set ns.broken = ns.broken + [label] -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            {{ ns.broken | join(', ') if ns.broken else 'none' }}

          healthy_labels: >-
            {%- set required = [
              'Zen Cabinet','Zen System Cabinet','Zen Dojo Cabinet','Zen Kata Cabinet',
              'Zen Default Household','Zen Default Family','Zen User Cabinet',
              'Zen AI User Cabinet','Zen Squirrel','Zen Fusion','Zen History Cabinet'
            ] -%}

            {%- set ns = namespace(healthy=[]) -%}

            {%- for label in required -%}
              {%- set ents = (label_entities(label) or []) | list -%}
              {%- if ents | count > 0 -%}
                {%- set bad = ents | selectattr('state','in',['unavailable','unknown']) | list -%}
                {%- if bad | count == 0 -%}
                  {%- set ns.healthy = ns.healthy + [label] -%}
                {%- endif -%}
              {%- endif -%}
            {%- endfor -%}

            {{ ns.healthy | join(', ') if ns.healthy else 'none' }}

          timestamp: >-
            {{ now().isoformat() }}
